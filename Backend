{
  "name": "focused-backend",
  "version": "1.0.0",
  "main": "server.js",
  "type": "module",
  "dependencies": {
    "bcrypt": "^5.1.0",
    "cors": "^2.8.5",
    "express": "^4.18.2",
    "jsonwebtoken": "^9.0.2",
    "sqlite3": "^5.1.6"
  }
}

import express from "express";
import cors from "cors";
import sqlite3 from "sqlite3";
import jwt from "jsonwebtoken";
import bcrypt from "bcrypt";

const app = express();
app.use(cors());
app.use(express.json());

const SECRET = "SUPER_SECRET_KEY";

// SQLite Database
const db = new sqlite3.Database("./focus.db");

// Initialize tables
db.run(`
  CREATE TABLE IF NOT EXISTS users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    username TEXT UNIQUE,
    password TEXT,
    focus_points INTEGER DEFAULT 0,
    chain INTEGER DEFAULT 0
  )
`);

db.run(`
  CREATE TABLE IF NOT EXISTS sessions (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER,
    subject TEXT,
    duration INTEGER,
    timestamp DATETIME DEFAULT CURRENT_TIMESTAMP
  )
`);


// ---------------- AUTH -------------------
app.post("/api/register", (req, res) => {
  const { username, password } = req.body;

  bcrypt.hash(password, 10).then(hash => {
    db.run(
      `INSERT INTO users (username, password) VALUES (?, ?)`,
      [username, hash],
      err => {
        if (err) return res.status(400).json({ error: "User exists" });
        res.json({ message: "Registered!" });
      }
    );
  });
});

app.post("/api/login", (req, res) => {
  const { username, password } = req.body;

  db.get(`SELECT * FROM users WHERE username=?`, [username], async (err, user) => {
    if (!user) return res.status(400).json({ error: "User not found" });

    const match = await bcrypt.compare(password, user.password);
    if (!match) return res.status(400).json({ error: "Wrong password" });

    const token = jwt.sign({ id: user.id }, SECRET);
    res.json({ token });
  });
});


// Middleware auth
function auth(req, res, next) {
  const token = req.headers.authorization;
  if (!token) return res.status(401).json({ error: "No token" });

  try {
    req.user = jwt.verify(token, SECRET);
    next();
  } catch {
    res.status(401).json({ error: "Invalid token" });
  }
}


// ---------------- FOCUS SESSION -------------------
app.post("/api/start-session", auth, (req, res) => {
  res.json({ message: "Session started" });
});

app.post("/api/complete-session", auth, (req, res) => {
  const { durationMinutes, subject } = req.body;

  db.run(
    `INSERT INTO sessions (user_id, subject, duration) VALUES (?, ?, ?)`,
    [req.user.id, subject, durationMinutes]
  );

  const earned = durationMinutes;

  db.run(
    `UPDATE users SET focus_points = focus_points + ?, chain = chain + 1 WHERE id=?`,
    [earned, req.user.id]
  );

  res.json({ earned });
});


// ---------------- LEADERBOARD -------------------
app.get("/api/leaderboard", (req, res) => {
  db.all(
    `SELECT username, focus_points FROM users ORDER BY focus_points DESC LIMIT 10`,
    (err, rows) => {
      res.json(rows);
    }
  );
});


// ---------------- TIPS -------------------
app.get("/api/tips", (_, res) => {
  res.json([
    "Tắt thông báo trong lúc học",
    "Dùng Pomodoro 25/5",
    "Chọn 1 mục tiêu duy nhất",
    "Viết ra 3 việc quan trọng nhất trong ngày"
  ]);
});


// Run server
app.listen(5000, () => console.log("Backend running on port 5000"));
